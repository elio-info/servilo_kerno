name: ValidaciÃ³n de PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-conflicts:
    name: Verificar Conflictos de Merge
    runs-on: ubuntu-latest
    # Este job debe fallar si hay conflictos para bloquear el merge
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para verificar conflictos
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Verificar conflictos de merge
        id: check-conflicts
        run: |
          PR_BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          
          echo "ðŸ” Verificando conflictos entre $PR_BRANCH y $BASE_BRANCH..."
          
          # Obtener la Ãºltima referencia de la rama base
          git fetch origin $BASE_BRANCH:$BASE_BRANCH
          
          # Limpiar cualquier merge anterior
          git reset --hard HEAD
          git clean -fd
          
          # Intentar hacer merge en modo --no-commit para detectar conflictos
          set +e  # No fallar inmediatamente
          git merge --no-commit --no-ff origin/$BASE_BRANCH > /tmp/merge_output.txt 2>&1
          MERGE_STATUS=$?
          set -e  # Volver a fallar en errores
          
          MERGE_OUTPUT=$(cat /tmp/merge_output.txt)
          rm /tmp/merge_output.txt
          
          if [ $MERGE_STATUS -eq 0 ]; then
            echo "âœ… No hay conflictos de merge"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            # Abortar el merge de prueba
            git merge --abort 2>/dev/null || true
          elif [ $MERGE_STATUS -eq 1 ]; then
            # CÃ³digo 1 = conflictos detectados
            echo "âŒ âŒ âŒ CONFLICTOS DE MERGE DETECTADOS âŒ âŒ âŒ"
            echo ""
            echo "El PR no puede ser unido debido a conflictos con la rama base ($BASE_BRANCH)."
            echo ""
            echo "Por favor, resuelve los conflictos antes de continuar:"
            echo "1. Actualiza tu rama con: git pull origin $BASE_BRANCH"
            echo "2. Resuelve los conflictos manualmente"
            echo "3. Haz commit de los cambios resueltos"
            echo "4. Haz push de los cambios"
            echo ""
            echo "Detalles del merge:"
            echo "$MERGE_OUTPUT"
            echo ""
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
            exit 1  # FALLAR para bloquear el merge
          else
            # Otro tipo de error
            echo "âš ï¸ Error al verificar merge (cÃ³digo: $MERGE_STATUS)"
            echo "Salida:"
            echo "$MERGE_OUTPUT"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
            # En caso de error desconocido, tambiÃ©n fallamos para ser seguros
            exit 1
          fi

      - name: Comentar en PR si hay conflictos
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Conflictos de Merge Detectados
              
              Este PR tiene conflictos con la rama base **\`${baseRef}\`** y **no puede ser unido** hasta que se resuelvan.
              
              ### ðŸ”§ CÃ³mo resolver los conflictos:
              
              1. **Actualiza tu rama local:**
                 \`\`\`bash
                 git checkout ${headRef}
                 git pull origin ${baseRef}
                 \`\`\`
              
              2. **Resuelve los conflictos manualmente** en los archivos marcados
              
              3. **Haz commit de los cambios:**
                 \`\`\`bash
                 git add .
                 git commit -m "Resolve merge conflicts"
                 \`\`\`
              
              4. **Haz push de los cambios:**
                 \`\`\`bash
                 git push origin ${headRef}
                 \`\`\`
              
              Una vez resueltos los conflictos, este workflow se ejecutarÃ¡ nuevamente para verificar que todo estÃ© correcto.
              
              ---
              *Este comentario fue generado automÃ¡ticamente por el workflow de validaciÃ³n.*`
            })

  check-dependencies:
    name: Verificar Dependencias
    runs-on: ubuntu-latest
    needs: check-conflicts
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Verificar sincronizaciÃ³n package.json y package-lock.json
        run: |
          echo "ðŸ” Verificando sincronizaciÃ³n de dependencias..."
          if ! npm ci --dry-run 2>&1 | grep -q "npm WARN"; then
            echo "âœ… package.json y package-lock.json estÃ¡n sincronizados"
          else
            echo "âŒ Advertencias detectadas al verificar dependencias"
            npm ci --dry-run
            exit 1
          fi

      - name: Instalar dependencias
        run: npm ci
        continue-on-error: false

      - name: Verificar dependencias faltantes
        run: |
          echo "ðŸ” Verificando que todas las dependencias estÃ©n instaladas..."
          if npm ls --depth=0 2>&1 | grep -q "npm ERR"; then
            echo "âŒ Se detectaron dependencias faltantes o conflictos"
            npm ls --depth=0
            exit 1
          else
            echo "âœ… Todas las dependencias estÃ¡n correctamente instaladas"
          fi

      - name: Verificar vulnerabilidades (audit)
        run: |
          echo "ðŸ” Verificando vulnerabilidades de seguridad..."
          npm audit --audit-level=moderate || true
          # No falla el workflow por vulnerabilidades, solo las reporta

  validate-code:
    name: Validar CÃ³digo (Lint, Build, Tests)
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies]
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar Linter
        run: npm run lint
        continue-on-error: false

      - name: Compilar proyecto
        run: npm run build
        continue-on-error: false

      - name: Ejecutar tests unitarios
        run: npm test
        continue-on-error: true
        env:
          CI: true

      - name: Ejecutar tests e2e
        run: npm run test:e2e
        continue-on-error: true
        env:
          CI: true

  check-app-startup:
    name: Verificar Inicio de AplicaciÃ³n
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies, validate-code]
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Compilar proyecto
        run: npm run build

      - name: Crear certificados mock para CI
        run: |
          echo "ðŸ”§ Creando certificados mock para validaciÃ³n..."
          mkdir -p cert
          
          # Generar certificados RSA temporales para CI
          # Estos certificados solo se usan para verificar que la app puede iniciar
          openssl genrsa -out cert/key.pem 2048
          openssl rsa -in cert/key.pem -pubout -out cert/public.pem
          
          echo "âœ… Certificados mock creados"

      - name: Verificar que la aplicaciÃ³n puede iniciar
        run: |
          echo "ðŸš€ Intentando iniciar la aplicaciÃ³n para verificar que no hay errores de runtime..."
          
          # Variables de entorno mock para CI
          export PORT=3000
          export LOCAL_MONGO_DEV="mongodb://localhost:27017/test_db"
          export DB_NAME="test_db"
          export NODE_ENV="test"
          
          # Capturar salida para anÃ¡lisis
          OUTPUT_FILE=$(mktemp)
          
          # Intentar iniciar la aplicaciÃ³n con timeout
          # Esperamos que falle al conectarse a MongoDB, pero no por errores de mÃ³dulos/dependencias
          set +e  # No fallar en errores
          timeout 10s node dist/main.js > "$OUTPUT_FILE" 2>&1
          EXIT_CODE=$?
          set -e  # Volver a fallar en errores
          
          # Leer la salida
          OUTPUT=$(cat "$OUTPUT_FILE")
          rm "$OUTPUT_FILE"
          
          # El timeout devuelve 124 si se alcanza el timeout (esperado si MongoDB no estÃ¡ disponible)
          # CÃ³digo 0 = Ã©xito (improbable sin MongoDB)
          # CÃ³digo 124 = timeout (esperado, significa que la app iniciÃ³ pero no pudo conectar a MongoDB)
          # Otros cÃ³digos = error real
          
          if [ "$EXIT_CODE" = "124" ]; then
            echo "âœ… La aplicaciÃ³n iniciÃ³ correctamente (timeout esperado - MongoDB no disponible en CI)"
            echo "   Esto indica que todos los mÃ³dulos se cargaron correctamente"
          elif [ "$EXIT_CODE" = "0" ]; then
            echo "âœ… La aplicaciÃ³n iniciÃ³ y terminÃ³ correctamente"
          elif echo "$OUTPUT" | grep -qi "cannot find module\|module not found\|cannot resolve\|missing dependency"; then
            echo "âŒ Error: Dependencias faltantes o mÃ³dulos no encontrados"
            echo "$OUTPUT"
            exit 1
          elif echo "$OUTPUT" | grep -qi "syntax error\|parse error\|compilation error"; then
            echo "âŒ Error: Errores de sintaxis o compilaciÃ³n"
            echo "$OUTPUT"
            exit 1
          elif echo "$OUTPUT" | grep -qi "mongodb\|connection.*refused\|ECONNREFUSED"; then
            echo "âœ… La aplicaciÃ³n iniciÃ³ correctamente (error de conexiÃ³n a MongoDB esperado en CI)"
            echo "   Todos los mÃ³dulos se cargaron sin problemas"
          else
            echo "âš ï¸ La aplicaciÃ³n no pudo iniciar completamente"
            echo "Salida:"
            echo "$OUTPUT"
            echo ""
            echo "CÃ³digo de salida: $EXIT_CODE"
            echo ""
            echo "Esto puede indicar:"
            echo "  - Dependencias faltantes en runtime"
            echo "  - Errores de importaciÃ³n de mÃ³dulos"
            echo "  - Problemas de configuraciÃ³n"
            exit 1
          fi
        continue-on-error: false

  summary:
    name: Resumen de ValidaciÃ³n
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies, validate-code, check-app-startup]
    if: always()
    
    steps:
      - name: Mostrar resumen
        run: |
          echo "## ðŸ“‹ Resumen de ValidaciÃ³n del PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # VerificaciÃ³n de conflictos
          if [ "${{ needs.check-conflicts.result }}" == "success" ]; then
            echo "âœ… **VerificaciÃ³n de conflictos:** Sin conflictos detectados" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **VerificaciÃ³n de conflictos:** Se detectaron conflictos de merge" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # VerificaciÃ³n de dependencias
          if [ "${{ needs.check-dependencies.result }}" == "success" ]; then
            echo "âœ… **VerificaciÃ³n de dependencias:** Todas las dependencias estÃ¡n correctas" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **VerificaciÃ³n de dependencias:** Se detectaron problemas con las dependencias" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ValidaciÃ³n de cÃ³digo
          if [ "${{ needs.validate-code.result }}" == "success" ]; then
            echo "âœ… **ValidaciÃ³n de cÃ³digo:** Lint, build y tests pasaron correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ValidaciÃ³n de cÃ³digo:** Algunas validaciones fallaron. Revisa los logs para mÃ¡s detalles." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # VerificaciÃ³n de inicio de aplicaciÃ³n
          if [ "${{ needs.check-app-startup.result }}" == "success" ]; then
            echo "âœ… **VerificaciÃ³n de inicio:** La aplicaciÃ³n puede iniciar sin errores de runtime" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **VerificaciÃ³n de inicio:** La aplicaciÃ³n no pudo iniciar correctamente" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Resumen final
          ALL_SUCCESS=true
          if [ "${{ needs.check-conflicts.result }}" != "success" ] || \
             [ "${{ needs.check-dependencies.result }}" != "success" ] || \
             [ "${{ needs.validate-code.result }}" != "success" ] || \
             [ "${{ needs.check-app-startup.result }}" != "success" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "$ALL_SUCCESS" = "true" ]; then
            echo "### âœ… **Todas las validaciones pasaron correctamente**" >> $GITHUB_STEP_SUMMARY
            echo "El PR estÃ¡ listo para revisiÃ³n." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **Algunas validaciones fallaron**" >> $GITHUB_STEP_SUMMARY
            echo "Por favor, revisa los logs de los jobs que fallaron y corrige los problemas antes de solicitar revisiÃ³n." >> $GITHUB_STEP_SUMMARY
          fi

