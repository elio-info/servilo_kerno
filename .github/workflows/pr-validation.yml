name: Validaci√≥n de PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-conflicts:
    name: Verificar Conflictos de Merge
    runs-on: ubuntu-latest
    # Este job debe fallar si hay conflictos para bloquear el merge
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para verificar conflictos
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Verificar conflictos de merge
        id: check-conflicts
        run: |
          PR_BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          
          echo "üîç Verificando conflictos entre $PR_BRANCH y $BASE_BRANCH..."
          
          # Obtener la √∫ltima referencia de la rama base
          git fetch origin $BASE_BRANCH:$BASE_BRANCH
          git reset --hard HEAD
          git clean -fd
          
          set +e
          git merge --no-commit --no-ff origin/$BASE_BRANCH > /tmp/merge_output.txt 2>&1
          MERGE_STATUS=$?
          set -e
          
          MERGE_OUTPUT=$(cat /tmp/merge_output.txt)
          rm /tmp/merge_output.txt
          
          if [ $MERGE_STATUS -eq 0 ]; then
            echo "‚úÖ No hay conflictos de merge"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
          elif [ $MERGE_STATUS -eq 1 ]; then
            echo "‚ùå ‚ùå ‚ùå CONFLICTOS DE MERGE DETECTADOS ‚ùå ‚ùå ‚ùå"
            echo ""
            echo "El PR no puede ser unido debido a conflictos con la rama base ($BASE_BRANCH)."
            echo ""
            echo "Por favor, resuelve los conflictos antes de continuar:"
            echo "1. Actualiza tu rama con: git pull origin $BASE_BRANCH"
            echo "2. Resuelve los conflictos manualmente"
            echo "3. Haz commit de los cambios resueltos"
            echo "4. Haz push de los cambios"
            echo ""
            echo "Detalles del merge:"
            echo "$MERGE_OUTPUT"
            echo ""
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
            exit 1
          else
            echo "‚ö†Ô∏è Error al verificar merge (c√≥digo: $MERGE_STATUS)"
            echo "Salida:"
            echo "$MERGE_OUTPUT"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            git merge --abort 2>/dev/null || true
            exit 1
          fi

      - name: Comentar en PR si hay conflictos
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseRef = context.payload.pull_request.base.ref;
            const headRef = context.payload.pull_request.head.ref;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Conflictos de Merge Detectados
              
              Este PR tiene conflictos con la rama base **\`${baseRef}\`** y **no puede ser unido** hasta que se resuelvan.
              
              ### üîß C√≥mo resolver los conflictos:
              
              1. **Actualiza tu rama local:**
                 \`\`\`bash
                 git checkout ${headRef}
                 git pull origin ${baseRef}
                 \`\`\`
              
              2. **Resuelve los conflictos manualmente** en los archivos marcados
              
              3. **Haz commit de los cambios:**
                 \`\`\`bash
                 git add .
                 git commit -m "Resolve merge conflicts"
                 \`\`\`
              
              4. **Haz push de los cambios:**
                 \`\`\`bash
                 git push origin ${headRef}
                 \`\`\`
              
              Una vez resueltos los conflictos, este workflow se ejecutar√° nuevamente para verificar que todo est√© correcto.
              
              ---
              *Este comentario fue generado autom√°ticamente por el workflow de validaci√≥n.*`
            })

  check-dependencies:
    name: Verificar Dependencias
    runs-on: ubuntu-latest
    needs: check-conflicts
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Verificar sincronizaci√≥n package.json y package-lock.json
        run: |
          echo "üîç Verificando sincronizaci√≥n de dependencias..."
          if ! npm ci --dry-run 2>&1 | grep -q "npm WARN"; then
            echo "‚úÖ package.json y package-lock.json est√°n sincronizados"
          else
            echo "‚ùå Advertencias detectadas al verificar dependencias"
            npm ci --dry-run
            exit 1
          fi

      - name: Instalar dependencias
        run: npm ci
        continue-on-error: false

      - name: Verificar dependencias faltantes
        run: |
          echo "üîç Verificando que todas las dependencias est√©n instaladas..."
          if npm ls --depth=0 2>&1 | grep -q "npm ERR"; then
            echo "‚ùå Se detectaron dependencias faltantes o conflictos"
            npm ls --depth=0
            exit 1
          else
            echo "‚úÖ Todas las dependencias est√°n correctamente instaladas"
          fi

      - name: Verificar vulnerabilidades (audit)
        run: |
          echo "üîç Verificando vulnerabilidades de seguridad..."
          npm audit --audit-level=moderate || true
          # No falla el workflow por vulnerabilidades, solo las reporta

  validate-code:
    name: Validar C√≥digo (Lint, Build, Tests)
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies]
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar Linter
        run: |
          echo "üîç Ejecutando linter..."
<<<<<<< Updated upstream
          # Ejecutar linter sin --fix primero para verificar solo errores
          # Usar npx eslint directamente para tener m√°s control
          set +e  # No fallar inmediatamente
          npx eslint "{src,apps,libs,test}/**/*.ts" --format=compact 2>&1 | tee /tmp/lint-output.txt
          LINT_EXIT=$?
          set -e  # Volver a fallar en errores
          
          # Contar errores y warnings
=======
          set +e
          npx eslint "{src,apps,libs,test}/**/*.ts" --format=compact 2>&1 | tee /tmp/lint-output.txt
          LINT_EXIT=$?
          set -e
          
>>>>>>> Stashed changes
          ERROR_COUNT=$(grep -c "error" /tmp/lint-output.txt || echo "0")
          WARNING_COUNT=$(grep -c "warning" /tmp/lint-output.txt || echo "0")
          
          echo ""
          echo "üìä Resumen del linter:"
          echo "   Errores: $ERROR_COUNT"
          echo "   Advertencias: $WARNING_COUNT"
          echo ""
          
<<<<<<< Updated upstream
          # Solo fallar si hay errores reales
=======
>>>>>>> Stashed changes
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ùå Se encontraron $ERROR_COUNT error(es) en el linter"
            echo "Por favor, corrige los errores antes de continuar:"
            cat /tmp/lint-output.txt
            rm -f /tmp/lint-output.txt
            exit 1
          elif [ "$WARNING_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Se encontraron $WARNING_COUNT advertencia(s), pero no hay errores"
            echo "El workflow continuar√°, pero se recomienda revisar las advertencias"
            cat /tmp/lint-output.txt
          else
            echo "‚úÖ Linter pas√≥ sin errores ni advertencias"
          fi
          
<<<<<<< Updated upstream
          # Ahora ejecutar con --fix para corregir autom√°ticamente lo que se pueda
          echo ""
          echo "üîß Aplicando correcciones autom√°ticas..."
          npm run lint || true  # No fallar si hay warnings despu√©s del fix
=======
          echo ""
          echo "üîß Aplicando correcciones autom√°ticas..."
          npm run lint || true
>>>>>>> Stashed changes
          
          rm -f /tmp/lint-output.txt
        continue-on-error: false

      - name: Compilar proyecto
        run: npm run build
        continue-on-error: false

      - name: Ejecutar tests unitarios
        run: npm test
        continue-on-error: true
        env:
          CI: true

      - name: Ejecutar tests e2e
        run: npm run test:e2e
        continue-on-error: true
        env:
          CI: true

  check-app-startup:
    name: Verificar Inicio de Aplicaci√≥n
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies, validate-code]
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Compilar proyecto
        run: npm run build

      - name: Crear certificados mock para CI
        run: |
          echo "üîß Creando certificados mock para validaci√≥n..."
          mkdir -p cert
          
          # Generar certificados RSA temporales para CI
          # Estos certificados solo se usan para verificar que la app puede iniciar
          openssl genrsa -out cert/key.pem 2048
          openssl rsa -in cert/key.pem -pubout -out cert/public.pem
          
          echo "‚úÖ Certificados mock creados"

      - name: Verificar que la aplicaci√≥n puede iniciar
        run: |
          echo "üöÄ Intentando iniciar la aplicaci√≥n para verificar que no hay errores de runtime..."
          
          # Variables de entorno mock para CI
          export PORT=3000
          export LOCAL_MONGO_DEV="mongodb://localhost:27017/test_db"
          export DB_NAME="test_db"
          export NODE_ENV="test"
          
          # Capturar salida para an√°lisis
          OUTPUT_FILE=$(mktemp)
          
          # Intentar iniciar la aplicaci√≥n con timeout
          # Esperamos que falle al conectarse a MongoDB, pero no por errores de m√≥dulos/dependencias
          set +e  # No fallar en errores
          timeout 10s node dist/main.js > "$OUTPUT_FILE" 2>&1
          EXIT_CODE=$?
          set -e  # Volver a fallar en errores
          
          # Leer la salida
          OUTPUT=$(cat "$OUTPUT_FILE")
          rm "$OUTPUT_FILE"
          
          # El timeout devuelve 124 si se alcanza el timeout (esperado si MongoDB no est√° disponible)
          # C√≥digo 0 = √©xito (improbable sin MongoDB)
          # C√≥digo 124 = timeout (esperado, significa que la app inici√≥ pero no pudo conectar a MongoDB)
          # Otros c√≥digos = error real
          
          if [ "$EXIT_CODE" = "124" ]; then
            echo "‚úÖ La aplicaci√≥n inici√≥ correctamente (timeout esperado - MongoDB no disponible en CI)"
            echo "   Esto indica que todos los m√≥dulos se cargaron correctamente"
          elif [ "$EXIT_CODE" = "0" ]; then
            echo "‚úÖ La aplicaci√≥n inici√≥ y termin√≥ correctamente"
          elif echo "$OUTPUT" | grep -qi "cannot find module\|module not found\|cannot resolve\|missing dependency"; then
            echo "‚ùå Error: Dependencias faltantes o m√≥dulos no encontrados"
            echo "$OUTPUT"
            exit 1
          elif echo "$OUTPUT" | grep -qi "syntax error\|parse error\|compilation error"; then
            echo "‚ùå Error: Errores de sintaxis o compilaci√≥n"
            echo "$OUTPUT"
            exit 1
          elif echo "$OUTPUT" | grep -qi "mongodb\|connection.*refused\|ECONNREFUSED"; then
            echo "‚úÖ La aplicaci√≥n inici√≥ correctamente (error de conexi√≥n a MongoDB esperado en CI)"
            echo "   Todos los m√≥dulos se cargaron sin problemas"
          else
            echo "‚ö†Ô∏è La aplicaci√≥n no pudo iniciar completamente"
            echo "Salida:"
            echo "$OUTPUT"
            echo ""
            echo "C√≥digo de salida: $EXIT_CODE"
            echo ""
            echo "Esto puede indicar:"
            echo "  - Dependencias faltantes en runtime"
            echo "  - Errores de importaci√≥n de m√≥dulos"
            echo "  - Problemas de configuraci√≥n"
            exit 1
          fi
        continue-on-error: false

  summary:
    name: Resumen de Validaci√≥n
    runs-on: ubuntu-latest
    needs: [check-conflicts, check-dependencies, validate-code, check-app-startup]
    if: always()
    
    steps:
      - name: Mostrar resumen
        run: |
          echo "## üìã Resumen de Validaci√≥n del PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificaci√≥n de conflictos
          if [ "${{ needs.check-conflicts.result }}" == "success" ]; then
            echo "‚úÖ **Verificaci√≥n de conflictos:** Sin conflictos detectados" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Verificaci√≥n de conflictos:** Se detectaron conflictos de merge" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificaci√≥n de dependencias
          if [ "${{ needs.check-dependencies.result }}" == "success" ]; then
            echo "‚úÖ **Verificaci√≥n de dependencias:** Todas las dependencias est√°n correctas" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Verificaci√≥n de dependencias:** Se detectaron problemas con las dependencias" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validaci√≥n de c√≥digo
          if [ "${{ needs.validate-code.result }}" == "success" ]; then
            echo "‚úÖ **Validaci√≥n de c√≥digo:** Lint, build y tests pasaron correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Validaci√≥n de c√≥digo:** Algunas validaciones fallaron. Revisa los logs para m√°s detalles." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificaci√≥n de inicio de aplicaci√≥n
          if [ "${{ needs.check-app-startup.result }}" == "success" ]; then
            echo "‚úÖ **Verificaci√≥n de inicio:** La aplicaci√≥n puede iniciar sin errores de runtime" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Verificaci√≥n de inicio:** La aplicaci√≥n no pudo iniciar correctamente" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Resumen final
          ALL_SUCCESS=true
          if [ "${{ needs.check-conflicts.result }}" != "success" ] || \
             [ "${{ needs.check-dependencies.result }}" != "success" ] || \
             [ "${{ needs.validate-code.result }}" != "success" ] || \
             [ "${{ needs.check-app-startup.result }}" != "success" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "$ALL_SUCCESS" = "true" ]; then
            echo "### ‚úÖ **Todas las validaciones pasaron correctamente**" >> $GITHUB_STEP_SUMMARY
            echo "El PR est√° listo para revisi√≥n." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è **Algunas validaciones fallaron**" >> $GITHUB_STEP_SUMMARY
            echo "Por favor, revisa los logs de los jobs que fallaron y corrige los problemas antes de solicitar revisi√≥n." >> $GITHUB_STEP_SUMMARY
          fi

